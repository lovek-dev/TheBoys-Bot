# Discord Music Bot

## Overview

This is a Discord music bot built with Discord.js v14 and DisTube that provides music playback from YouTube and Spotify, along with utility features like announcements and activity tracking. The bot uses slash commands for all interactions and includes a lightweight Express web server for health checks.

## User Preferences

Preferred communication style: Simple, everyday language.

## System Architecture

### Bot Framework & Music System

**Technology Stack:**
- Discord.js v14 for Discord API interactions
- DisTube v5 for music streaming and queue management
- @distube/spotify plugin for Spotify integration
- Express.js for web server health endpoint

**Music Playback Architecture:**
The bot uses DisTube as the core music engine, which handles:
- Audio streaming from YouTube (via @distube/ytdl-core)
- Spotify track resolution and playback (via SpotifyPlugin)
- Queue management with previous song history
- Voice channel connection and audio encoding (ffmpeg-static, opusscript)

The music system is designed to:
- Join new voice channels automatically when requested
- Maintain separate queues per voice channel
- Support both direct URLs and search queries
- Handle multiple audio sources seamlessly

### Command System

**Slash Command Architecture:**
All bot interactions use Discord's native slash commands (Application Commands). Commands are:
- Loaded dynamically from the `/src/commands` directory
- Registered as a Collection on the client instance
- Executed through Discord's interaction system

**Command Categories:**

1. **Music Commands** (`/play`, `/pause`, `/skip`, `/stop`, `/queue`)
   - Require voice channel presence validation
   - Access DisTube queue instance for the user's voice channel
   - Provide rich embed responses for user feedback

2. **Utility Commands** (`/announce`, `/active`)
   - `/announce`: Permission-gated (ManageMessages) for server moderation
   - `/active`: Displays bot metrics for Discord developer badge eligibility

### Event-Driven Architecture

The bot uses an event handler system that:
- Dynamically loads event listeners from `/src/events`
- Separates concerns between bot lifecycle and command execution
- Implements the `ready` event for initialization logging and status setting

### Configuration Management

Environment-based configuration through `/src/config/config.js`:
- Discord bot token and client ID
- Spotify API credentials (client ID and secret)
- All sensitive data loaded from environment variables

**Design Decision:** Configuration is centralized in a single module to enable easy updates and maintain security by keeping credentials out of source code.

### Web Server Component

A minimal Express server runs on port 5000 to:
- Provide a health check endpoint (`/`) for uptime monitoring
- Enable deployment on platforms requiring HTTP endpoints
- Bootstrap the Discord bot after server initialization

**Rationale:** Many cloud platforms and hosting services require an HTTP server for health checks. This lightweight server satisfies that requirement while keeping the main focus on Discord functionality.

### Permission & Validation Layer

Commands implement multi-level validation:
1. Voice channel presence checks for music commands
2. Discord permission validation (e.g., ManageMessages for announcements)
3. Bot permission verification (SendMessages, EmbedLinks, Connect, Speak)

**Design Pattern:** Fail-fast validation with ephemeral error messages to provide immediate user feedback without cluttering channels.

## External Dependencies

### Discord API
- **Service**: Discord Gateway and HTTP API via Discord.js v14
- **Purpose**: Bot authentication, slash command registration, guild/channel/voice interactions
- **Required Credentials**: `DISCORD_BOT_TOKEN`, `CLIENT_ID`

### Spotify Web API
- **Service**: Spotify Developer API
- **Purpose**: Resolving Spotify track/playlist/album URLs to playable audio
- **Required Credentials**: `SPOTIFY_CLIENT_ID`, `SPOTIFY_CLIENT_SECRET`
- **Integration**: Through @distube/spotify plugin for seamless playback

### Media Processing
- **FFmpeg** (ffmpeg-static): Audio encoding and format conversion for Discord voice
- **Opus Codec** (opusscript): Audio compression for efficient voice transmission
- **YTDL** (@distube/ytdl-core): YouTube video/audio extraction

### Voice Infrastructure
- **@discordjs/voice**: Discord voice connection management and audio streaming
- **libsodium-wrappers**: Encryption for Discord voice protocol

### Hosting/Runtime
- **Node.js**: Runtime environment (requires v20+)
- **Express**: HTTP server for health checks on port 5000
- **Environment Variables**: Configuration via Replit Secrets

## Recent Changes (November 14, 2025)

### Fixes and Improvements
1. **Fixed /play command** - Now properly supports Spotify URLs using DisTube v5 and @distube/spotify v2.0.2
2. **Fixed /announce command** - Added proper permission checks and error handling for channel validation
3. **Added /active command** - New command for Discord developer badge eligibility showing bot uptime and stats
4. **Updated DisTube configuration** - Removed deprecated v4 options, using only v5-compatible settings
5. **Added music control commands** - /skip, /stop, /queue, /pause for full playback control
6. **Improved error handling** - All commands now have proper error messages and ephemeral responses

### Bot Commands Available
- `/play <song>` - Play music from YouTube or Spotify
- `/pause` - Pause or resume the current song
- `/skip` - Skip to the next song
- `/stop` - Stop playback and clear queue
- `/queue` - Display the current music queue
- `/announce` - Send announcements (requires Manage Messages permission)
- `/active` - Show bot activity stats for developer badge

### Setup Requirements
The bot requires four environment secrets (already configured in Replit Secrets):
- DISCORD_BOT_TOKEN - Bot token from Discord Developer Portal
- CLIENT_ID - Application ID from Discord Developer Portal
- SPOTIFY_CLIENT_ID - Client ID from Spotify Developer Dashboard
- SPOTIFY_CLIENT_SECRET - Client Secret from Spotify Developer Dashboard